{% extends "base.html" %}
{% block title %}
    {% if action == 'edit' %}ç¼–è¾‘è¯å…¸{% else %}ä¸Šä¼ æ–°è¯å…¸{% endif %} - EasyDict è´¡çŒ®è€…å¹³å°
{% endblock %}

{% block content %}
<div class="container" style="max-width:680px">

    <div style="margin-bottom:20px">
        <a class="link" href="{{ url_for('dashboard') }}">&larr; è¿”å›æ§åˆ¶å°</a>
    </div>

    <div class="card">
        <div class="card-title">
            {% if action == 'edit' %}ç¼–è¾‘è¯å…¸{% else %}ä¸Šä¼ æ–°è¯å…¸{% endif %}
        </div>
        <div class="card-sub">
            {% if action == 'edit' %}
                æ›¿æ¢éœ€è¦æ›´æ–°çš„æ–‡ä»¶ï¼Œç•™ç©ºåˆ™ä¿ç•™åŸæ–‡ä»¶
            {% else %}
                ä¸Šä¼ ä¸€ä¸ªæ–°çš„è¯å…¸åˆ° EasyDict
            {% endif %}
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alerts">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="post" enctype="multipart/form-data"
              action="{% if action == 'edit' %}{{ url_for('edit_dict', dict_id=dict.dict_id) }}{% else %}{{ url_for('new_dict') }}{% endif %}">

            <div style="font-size:.9rem;font-weight:700;margin-bottom:14px">
                è¯å…¸æ–‡ä»¶
                {% if action == 'edit' %}
                <span style="font-weight:400;color:var(--text-muted)">ï¼ˆåªä¸Šä¼ éœ€è¦æ›¿æ¢çš„æ–‡ä»¶ï¼‰</span>
                {% endif %}
            </div>

            {% if action != 'edit' %}
            <div class="alert alert-info" style="margin-bottom:16px;font-size:.82rem">
                <div>
                    è¯å…¸ ID å°†ä» <code>metadata.json</code> çš„ <code>id</code> å­—æ®µè‡ªåŠ¨è¯»å–ã€‚<br>
                    <strong>metadata.json å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</strong><br>
                    <code style="font-size:.78rem;word-break:break-all">
                        id, name, source_language, target_language
                    </code>
                </div>
            </div>
            {% endif %}

            <div class="files-grid">
                <!-- metadata.json -->
                <div class="form-group">
                    <label>
                        metadata.json
                        {% if action != 'edit' %}<span class="required-badge">å¿…éœ€</span>{% else %}<span class="optional-badge">å¯é€‰</span>{% endif %}
                    </label>
                    <div class="upload-area" data-expected="metadata.json">
                        <input type="file" name="metadata.json" accept=".json">
                        <span class="upload-icon">ğŸ“„</span>
                        <div class="upload-label"><strong>ç‚¹å‡»</strong>æˆ–æ‹–æ‹½ä¸Šä¼ </div>
                        <div class="file-name"></div>
                    </div>
                    <div class="hint">è¯å…¸å…ƒæ•°æ® JSON æ–‡ä»¶</div>
                </div>

                <!-- dictionary.db -->
                <div class="form-group">
                    <label>
                        dictionary.db
                        {% if action != 'edit' %}<span class="required-badge">å¿…éœ€</span>{% else %}<span class="optional-badge">å¯é€‰</span>{% endif %}
                    </label>
                    <div class="upload-area" data-expected="dictionary.db">
                        <input type="file" name="dictionary.db" accept=".db">
                        <span class="upload-icon">ğŸ—ƒï¸</span>
                        <div class="upload-label"><strong>ç‚¹å‡»</strong>æˆ–æ‹–æ‹½ä¸Šä¼ </div>
                        <div class="file-name"></div>
                    </div>
                    <div class="hint">SQLite è¯å…¸æ•°æ®åº“</div>
                </div>

                <!-- logo.png -->
                <div class="form-group">
                    <label>
                        logo.png
                        {% if action != 'edit' %}<span class="required-badge">å¿…éœ€</span>{% else %}<span class="optional-badge">å¯é€‰</span>{% endif %}
                    </label>
                    <div class="upload-area" data-expected="logo.png">
                        <input type="file" name="logo.png" accept="image/png">
                        <span class="upload-icon">ğŸ–¼ï¸</span>
                        <div class="upload-label"><strong>ç‚¹å‡»</strong>æˆ–æ‹–æ‹½ä¸Šä¼ </div>
                        <div class="file-name"></div>
                    </div>
                    <div class="hint">è¯å…¸ Logoï¼ˆPNG æ ¼å¼ï¼‰</div>
                </div>

                <!-- media.db -->
                <div class="form-group">
                    <label>
                        media.db
                        <span class="optional-badge">å¯é€‰</span>
                    </label>
                    <div class="upload-area" data-expected="media.db">
                        <input type="file" name="media.db" accept=".db">
                        <span class="upload-icon">ğŸµ</span>
                        <div class="upload-label"><strong>ç‚¹å‡»</strong>æˆ–æ‹–æ‹½ä¸Šä¼ </div>
                        <div class="file-name"></div>
                    </div>
                    <div class="hint">éŸ³é¢‘/å›¾ç‰‡åª’ä½“æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰</div>
                </div>
            </div>

            {% if action == 'edit' %}
            <div class="form-group" style="margin-top:16px">
                <label>æ›´æ–°è¯´æ˜ <span class="required-badge">å¿…å¡«</span></label>
                <textarea name="update_message" rows="2"
                          placeholder="ç®€è¿°æœ¬æ¬¡æ›´æ–°çš„å†…å®¹â€¦"
                          style="width:100%;resize:vertical;" required></textarea>
            </div>
            {% endif %}

            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px">
                <a class="btn btn-outline" href="{{ url_for('dashboard') }}">å–æ¶ˆ</a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    {% if action == 'edit' %}ä¿å­˜æ›´æ–°{% else %}ä¸Šä¼ è¯å…¸{% endif %}
                </button>
            </div>

        </form>
    </div>
</div>

{% block extra_script %}
<script>
// Per-slot filename validation with visual feedback
document.querySelectorAll('.upload-area[data-expected]').forEach(function(area) {
    var expected = area.dataset.expected;
    var input = area.querySelector('input[type="file"]');
    var label = area.querySelector('.file-name');

    input.addEventListener('change', function() {
        if (!this.files.length) { label.textContent = ''; label.style.color = ''; return; }
        var actual = this.files[0].name;
        var size = (this.files[0].size / 1024 / 1024).toFixed(1);
        if (actual !== expected) {
            label.textContent = 'âœ— æ–‡ä»¶åé”™è¯¯ï¼šåº”ä¸º ' + expected;
            label.style.color = 'var(--danger)';
            area.style.borderColor = 'var(--danger)';
        } else {
            label.textContent = 'âœ“ ' + actual + ' (' + size + ' MB)';
            label.style.color = 'var(--success)';
            area.style.borderColor = 'var(--success)';
        }
    });
});

// Block submit if any selected file has wrong name
document.querySelector('form').addEventListener('submit', function(e) {
    var bad = [];
    document.querySelectorAll('.upload-area[data-expected]').forEach(function(area) {
        var expected = area.dataset.expected;
        var input = area.querySelector('input[type="file"]');
        if (input.files.length && input.files[0].name !== expected) {
            bad.push('"' + input.files[0].name + '" (åº”ä¸º ' + expected + ')');
        }
    });
    if (bad.length) {
        e.preventDefault();
        alert('æ–‡ä»¶åé”™è¯¯ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼š\n' + bad.join('\n'));
    }
});
</script>
{% endblock %}
{% endblock %}
